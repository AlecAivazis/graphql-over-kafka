

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>flask_admin.model.base &mdash; nautilus v0.3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="nautilus v0.3.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> nautilus
          

          
          </a>

          
            
            
              <div class="version">
                v0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../handlers/index.html">Action Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schema/index.html">Service API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utilities/index.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/index.html">Module Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">nautilus</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>flask_admin.model.base</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for flask_admin.model.base</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span>
                   <span class="n">get_flashed_messages</span><span class="p">,</span> <span class="n">stream_with_context</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">contextfunction</span>
<span class="kn">from</span> <span class="nn">wtforms.fields</span> <span class="kn">import</span> <span class="n">HiddenField</span>
<span class="kn">from</span> <span class="nn">wtforms.fields.core</span> <span class="kn">import</span> <span class="n">UnboundField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">InputRequired</span>

<span class="kn">from</span> <span class="nn">flask_admin.babel</span> <span class="kn">import</span> <span class="n">gettext</span>

<span class="kn">from</span> <span class="nn">flask_admin.base</span> <span class="kn">import</span> <span class="n">BaseView</span><span class="p">,</span> <span class="n">expose</span>
<span class="kn">from</span> <span class="nn">flask_admin.form</span> <span class="kn">import</span> <span class="n">BaseForm</span><span class="p">,</span> <span class="n">FormOpts</span><span class="p">,</span> <span class="n">rules</span>
<span class="kn">from</span> <span class="nn">flask_admin.model</span> <span class="kn">import</span> <span class="n">filters</span><span class="p">,</span> <span class="n">typefmt</span>
<span class="kn">from</span> <span class="nn">flask_admin.actions</span> <span class="kn">import</span> <span class="n">ActionsMixin</span>
<span class="kn">from</span> <span class="nn">flask_admin.helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_form_data</span><span class="p">,</span> <span class="n">validate_form_on_submit</span><span class="p">,</span>
                                 <span class="n">get_redirect_target</span><span class="p">,</span> <span class="n">flash_errors</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">flask_admin.tools</span> <span class="kn">import</span> <span class="n">rec_getattr</span>
<span class="kn">from</span> <span class="nn">flask_admin._backwards</span> <span class="kn">import</span> <span class="n">ObsoleteAttr</span>
<span class="kn">from</span> <span class="nn">flask_admin._compat</span> <span class="kn">import</span> <span class="p">(</span><span class="n">iteritems</span><span class="p">,</span> <span class="n">itervalues</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span>
                                 <span class="n">as_unicode</span><span class="p">,</span> <span class="n">csv_encode</span><span class="p">,</span> <span class="n">text_type</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.helpers</span> <span class="kn">import</span> <span class="n">prettify_name</span><span class="p">,</span> <span class="n">get_mdict_item_or_list</span>
<span class="kn">from</span> <span class="nn">.ajax</span> <span class="kn">import</span> <span class="n">AjaxModelLoader</span>
<span class="kn">from</span> <span class="nn">.fields</span> <span class="kn">import</span> <span class="n">ListEditableFieldList</span>

<span class="c1"># Used to generate filter query string name</span>
<span class="n">filter_char_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[^a-z0-9 ]&#39;</span><span class="p">)</span>
<span class="n">filter_compact_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ViewArgs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List view arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_desc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort</span> <span class="o">=</span> <span class="n">sort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_desc</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sort_desc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search</span> <span class="o">=</span> <span class="n">search</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span> <span class="o">=</span> <span class="n">extra_args</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="n">flt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flt</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sort_desc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_desc</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">,</span> <span class="n">flt</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;extra_args&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ViewArgs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FilterGroup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">non_lazy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="n">copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">copy</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">as_unicode</span><span class="p">(</span><span class="n">copy</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">])</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">copy</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">copy</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">text_type</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>

            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">as_unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">),</span> <span class="n">filters</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseModelView</span><span class="p">(</span><span class="n">BaseView</span><span class="p">,</span> <span class="n">ActionsMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base model view.</span>

<span class="sd">        This view does not make any assumptions on how models are stored or managed, but expects the following:</span>

<span class="sd">            1. The provided model is an object</span>
<span class="sd">            2. The model contains properties</span>
<span class="sd">            3. Each model contains an attribute which uniquely identifies it (i.e. a primary key for a database model)</span>
<span class="sd">            4. It is possible to retrieve a list of sorted models with pagination applied from a data source</span>
<span class="sd">            5. You can get one model by its identifier from the data source</span>

<span class="sd">        Essentially, if you want to support a new data store, all you have to do is:</span>

<span class="sd">            1. Derive from the `BaseModelView` class</span>
<span class="sd">            2. Implement various data-related methods (`get_list`, `get_one`, `create_model`, etc)</span>
<span class="sd">            3. Implement automatic form generation from the model representation (`scaffold_form`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Permissions</span>
    <span class="n">can_create</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="sd">&quot;&quot;&quot;Is model creation allowed&quot;&quot;&quot;</span>

    <span class="n">can_edit</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="sd">&quot;&quot;&quot;Is model editing allowed&quot;&quot;&quot;</span>

    <span class="n">can_delete</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="sd">&quot;&quot;&quot;Is model deletion allowed&quot;&quot;&quot;</span>

    <span class="n">can_view_details</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setting this to true will enable the details view. This is recommended</span>
<span class="sd">        when there are too many columns to display in the list_view.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">can_export</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;Is model list export allowed&quot;&quot;&quot;</span>

    <span class="c1"># Templates</span>
    <span class="n">list_template</span> <span class="o">=</span> <span class="s1">&#39;admin/model/list.html&#39;</span>
    <span class="sd">&quot;&quot;&quot;Default list view template&quot;&quot;&quot;</span>

    <span class="n">edit_template</span> <span class="o">=</span> <span class="s1">&#39;admin/model/edit.html&#39;</span>
    <span class="sd">&quot;&quot;&quot;Default edit template&quot;&quot;&quot;</span>

    <span class="n">create_template</span> <span class="o">=</span> <span class="s1">&#39;admin/model/create.html&#39;</span>
    <span class="sd">&quot;&quot;&quot;Default create template&quot;&quot;&quot;</span>

    <span class="n">details_template</span> <span class="o">=</span> <span class="s1">&#39;admin/model/details.html&#39;</span>
    <span class="sd">&quot;&quot;&quot;Default details view template&quot;&quot;&quot;</span>

    <span class="c1"># Modal Templates</span>
    <span class="n">edit_modal_template</span> <span class="o">=</span> <span class="s1">&#39;admin/model/modals/edit.html&#39;</span>
    <span class="sd">&quot;&quot;&quot;Default edit modal template&quot;&quot;&quot;</span>

    <span class="n">create_modal_template</span> <span class="o">=</span> <span class="s1">&#39;admin/model/modals/create.html&#39;</span>
    <span class="sd">&quot;&quot;&quot;Default create modal template&quot;&quot;&quot;</span>

    <span class="n">details_modal_template</span> <span class="o">=</span> <span class="s1">&#39;admin/model/modals/details.html&#39;</span>
    <span class="sd">&quot;&quot;&quot;Default details modal view template&quot;&quot;&quot;</span>

    <span class="c1"># Modals</span>
    <span class="n">edit_modal</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;Setting this to true will display the edit_view as a modal dialog.&quot;&quot;&quot;</span>

    <span class="n">create_modal</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;Setting this to true will display the create_view as a modal dialog.&quot;&quot;&quot;</span>

    <span class="n">details_modal</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;Setting this to true will display the details_view as a modal dialog.&quot;&quot;&quot;</span>

    <span class="c1"># Customizations</span>
    <span class="n">column_list</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_list&#39;</span><span class="p">,</span> <span class="s1">&#39;list_columns&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of the model field names for the list view.</span>
<span class="sd">        If set to `None`, will get them from the model.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_list = (&#39;name&#39;, &#39;last_name&#39;, &#39;email&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_exclude_list</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_exclude_list&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;excluded_list_columns&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of excluded list column names.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_exclude_list = (&#39;last_name&#39;, &#39;email&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_details_list</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of the field names included in the details view.</span>
<span class="sd">        If set to `None`, will get them from the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_details_exclude_list</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of fields excluded from the details view.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_export_list</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of the field names included in the export.</span>
<span class="sd">        If set to `None`, will get them from the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_export_exclude_list</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of fields excluded from the export.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_formatters</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_formatters&#39;</span><span class="p">,</span> <span class="s1">&#39;list_formatters&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of list view column formatters.</span>

<span class="sd">        For example, if you want to show price multiplied by</span>
<span class="sd">        two, you can do something like this::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_formatters = dict(price=lambda v, c, m, p: m.price*2)</span>

<span class="sd">        or using Jinja2 `macro` in template::</span>

<span class="sd">            from flask_admin.model.template import macro</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_formatters = dict(price=macro(&#39;render_price&#39;))</span>

<span class="sd">            # in template</span>
<span class="sd">            {% macro render_price(model, column) %}</span>
<span class="sd">                {{ model.price * 2 }}</span>
<span class="sd">            {% endmacro %}</span>

<span class="sd">        The Callback function has the prototype::</span>

<span class="sd">            def formatter(view, context, model, name):</span>
<span class="sd">                # `view` is current administrative view</span>
<span class="sd">                # `context` is instance of jinja2.runtime.Context</span>
<span class="sd">                # `model` is model instance</span>
<span class="sd">                # `name` is property name</span>
<span class="sd">                pass</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_formatters_export</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of list view column formatters to be used for export.</span>

<span class="sd">        Defaults to column_formatters when set to None.</span>

<span class="sd">        Functions the same way as column_formatters except</span>
<span class="sd">        that macros are not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_type_formatters</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_type_formatters&#39;</span><span class="p">,</span> <span class="s1">&#39;list_type_formatters&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of value type formatters to be used in the list view.</span>

<span class="sd">        By default, three types are formatted:</span>

<span class="sd">        1. ``None`` will be displayed as an empty string</span>
<span class="sd">        2. ``bool`` will be displayed as a checkmark if it is ``True``</span>
<span class="sd">        3. ``list`` will be joined using &#39;, &#39;</span>

<span class="sd">        If you don&#39;t like the default behavior and don&#39;t want any type formatters</span>
<span class="sd">        applied, just override this property with an empty dictionary::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_type_formatters = dict()</span>

<span class="sd">        If you want to display `NULL` instead of an empty string, you can do</span>
<span class="sd">        something like this. Also comes with bonus `date` formatter::</span>

<span class="sd">            from datetime import date</span>
<span class="sd">            from flask_admin.model import typefmt</span>

<span class="sd">            def date_format(view, value):</span>
<span class="sd">                return value.strftime(&#39;%d.%m.%Y&#39;)</span>

<span class="sd">            MY_DEFAULT_FORMATTERS = dict(typefmt.BASE_FORMATTERS)</span>
<span class="sd">            MY_DEFAULT_FORMATTERS.update({</span>
<span class="sd">                    type(None): typefmt.null_formatter,</span>
<span class="sd">                    date: date_format</span>
<span class="sd">                })</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_type_formatters = MY_DEFAULT_FORMATTERS</span>

<span class="sd">        Type formatters have lower priority than list column formatters.</span>

<span class="sd">        The callback function has following prototype::</span>

<span class="sd">            def type_formatter(view, value):</span>
<span class="sd">                # `view` is current administrative view</span>
<span class="sd">                # `value` value to format</span>
<span class="sd">                pass</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_type_formatters_export</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of value type formatters to be used in the export.</span>

<span class="sd">        By default, two types are formatted:</span>

<span class="sd">        1. ``None`` will be displayed as an empty string</span>
<span class="sd">        2. ``list`` will be joined using &#39;, &#39;</span>

<span class="sd">        Functions the same way as column_type_formatters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_labels</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_labels&#39;</span><span class="p">,</span> <span class="s1">&#39;rename_columns&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary where key is column name and value is string to display.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_labels = dict(name=&#39;Name&#39;, last_name=&#39;Last Name&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_descriptions</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary where key is column name and</span>
<span class="sd">        value is description for `list view` column or add/edit form field.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_descriptions = dict(</span>
<span class="sd">                    full_name=&#39;First and Last name&#39;</span>
<span class="sd">                )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_sortable_list</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_sortable_list&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;sortable_columns&#39;</span><span class="p">,</span>
                                        <span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of the sortable columns for the list view.</span>
<span class="sd">        If set to `None`, will get them from the model.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_sortable_list = (&#39;name&#39;, &#39;last_name&#39;)</span>

<span class="sd">        If you want to explicitly specify field/column to be used while</span>
<span class="sd">        sorting, you can use a tuple::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_sortable_list = (&#39;name&#39;, (&#39;user&#39;, &#39;user.username&#39;))</span>

<span class="sd">        When using SQLAlchemy models, model attributes can be used instead</span>
<span class="sd">        of strings::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_sortable_list = (&#39;name&#39;, (&#39;user&#39;, User.username))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_default_sort</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default sort column if no sorting is applied.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_default_sort = &#39;user&#39;</span>

<span class="sd">        You can use tuple to control ascending descending order. In following example, items</span>
<span class="sd">        will be sorted in descending order::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_default_sort = (&#39;user&#39;, True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_searchable_list</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_searchable_list&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;searchable_columns&#39;</span><span class="p">,</span>
                                          <span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A collection of the searchable columns. It is assumed that only</span>
<span class="sd">        text-only fields are searchable, but it is up to the model</span>
<span class="sd">        implementation to decide.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_searchable_list = (&#39;name&#39;, &#39;email&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_editable_list</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of the columns which can be edited from the list view.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_editable_list = (&#39;name&#39;, &#39;last_name&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_choices</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map choices to columns in list view</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_choices = {</span>
<span class="sd">                    &#39;my_column&#39;: [</span>
<span class="sd">                        (&#39;db_value&#39;, &#39;display_value&#39;),</span>
<span class="sd">                    ]</span>
<span class="sd">                }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_filters</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of the column filters.</span>

<span class="sd">        Can contain either field names or instances of :class:`~flask_admin.model.filters.BaseFilter` classes.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                column_filters = (&#39;user&#39;, &#39;email&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">named_filter_urls</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set to True to use human-readable names for filters in URL parameters.</span>

<span class="sd">        False by default so as to be robust across translations.</span>

<span class="sd">        Changing this parameter will break any existing URLs that have filters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_display_pk</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;column_display_pk&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;list_display_pk&#39;</span><span class="p">,</span>
                                     <span class="bp">False</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Controls if the primary key should be displayed in the list view.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_display_actions</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Controls the display of the row actions (edit, delete, details, etc.)</span>
<span class="sd">        column in the list view.</span>

<span class="sd">        Useful for preventing a blank column from displaying if your view does</span>
<span class="sd">        not use any build-in or custom row actions.</span>

<span class="sd">        This column is not hidden automatically due to backwards compatibility.</span>

<span class="sd">        Note: This only affects display and does not control whether the row</span>
<span class="sd">        actions endpoints are accessible.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">simple_list_pager</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable or disable simple list pager.</span>
<span class="sd">        If enabled, model interface would not run count query and will only show prev/next pager buttons.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Form class. Override if you want to use custom form for your model.</span>
<span class="sd">        Will completely disable form scaffolding functionality.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyForm(Form):</span>
<span class="sd">                name = StringField(&#39;Name&#39;)</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form = MyForm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_base_class</span> <span class="o">=</span> <span class="n">BaseForm</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base form class. Will be used by form scaffolding function when creating model form.</span>

<span class="sd">        Useful if you want to have custom contructor or override some fields.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyBaseForm(Form):</span>
<span class="sd">                def do_something(self):</span>
<span class="sd">                    pass</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_base_class = MyBaseForm</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_args</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of form field arguments. Refer to WTForms documentation for</span>
<span class="sd">        list of possible options.</span>

<span class="sd">        Example::</span>

<span class="sd">            from wtforms.validators import DataRequired</span>
<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_args = dict(</span>
<span class="sd">                    name=dict(label=&#39;First Name&#39;, validators=[DataRequired()])</span>
<span class="sd">                )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_columns</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of the model field names for the form. If set to `None` will</span>
<span class="sd">        get them from the model.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_columns = (&#39;name&#39;, &#39;email&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_excluded_columns</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;form_excluded_columns&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;excluded_form_columns&#39;</span><span class="p">,</span>
                                         <span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collection of excluded form field names.</span>

<span class="sd">        For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_excluded_columns = (&#39;last_name&#39;, &#39;email&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_overrides</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of form column overrides.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_overrides = dict(name=wtf.FileField)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_widget_args</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of form widget rendering arguments.</span>
<span class="sd">        Use this to customize how widget is rendered without using custom template.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_widget_args = {</span>
<span class="sd">                    &#39;description&#39;: {</span>
<span class="sd">                        &#39;rows&#39;: 10,</span>
<span class="sd">                        &#39;style&#39;: &#39;color: black&#39;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        Changing the format of a DateTimeField will require changes to both form_widget_args and form_args.</span>

<span class="sd">        Example::</span>

<span class="sd">            form_args = dict(</span>
<span class="sd">                start=dict(format=&#39;%Y-%m-%d %I:%M %p&#39;) # changes how the input is parsed by strptime (12 hour time)</span>
<span class="sd">            )</span>
<span class="sd">            form_widget_args = dict(</span>
<span class="sd">                start={&#39;data-date-format&#39;: u&#39;yyyy-mm-dd HH:ii P&#39;, &#39;data-show-meridian&#39;: &#39;True&#39;} # changes how the DateTimeField displays the time</span>
<span class="sd">            )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_extra_fields</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of additional fields.</span>

<span class="sd">        Example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_extra_fields = {</span>
<span class="sd">                    &#39;password&#39;: PasswordField(&#39;Password&#39;)</span>
<span class="sd">                }</span>

<span class="sd">        You can control order of form fields using ``form_columns`` property. For example::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_columns = (&#39;name&#39;, &#39;email&#39;, &#39;password&#39;, &#39;secret&#39;)</span>

<span class="sd">                form_extra_fields = {</span>
<span class="sd">                    &#39;password&#39;: PasswordField(&#39;Password&#39;)</span>
<span class="sd">                }</span>

<span class="sd">        In this case, password field will be put between email and secret fields that are autogenerated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_ajax_refs</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use AJAX for foreign key model loading.</span>

<span class="sd">        Should contain dictionary, where key is field name and value is either a dictionary which</span>
<span class="sd">        configures AJAX lookups or backend-specific `AjaxModelLoader` class instance.</span>

<span class="sd">        For example, it can look like::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_ajax_refs = {</span>
<span class="sd">                    &#39;user&#39;: {</span>
<span class="sd">                        &#39;fields&#39;: (&#39;first_name&#39;, &#39;last_name&#39;, &#39;email&#39;),</span>
<span class="sd">                        &#39;page_size&#39;: 10</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        Or with SQLAlchemy backend like this::</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                form_ajax_refs = {</span>
<span class="sd">                    &#39;user&#39;: QueryAjaxModelLoader(&#39;user&#39;, db.session, User, fields=[&#39;email&#39;], page_size=10)</span>
<span class="sd">                }</span>

<span class="sd">        If you need custom loading functionality, you can implement your custom loading behavior</span>
<span class="sd">        in your `AjaxModelLoader` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_rules</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of rendering rules for model creation form.</span>

<span class="sd">        This property changed default form rendering behavior and makes possible to rearrange order</span>
<span class="sd">        of rendered fields, add some text between fields, group them, etc. If not set, will use</span>
<span class="sd">        default Flask-Admin form rendering logic.</span>

<span class="sd">        Here&#39;s simple example which illustrates how to use::</span>

<span class="sd">            from flask_admin.form import rules</span>

<span class="sd">            class MyModelView(ModelView):</span>
<span class="sd">                form_rules = [</span>
<span class="sd">                    # Define field set with header text and four fields</span>
<span class="sd">                    rules.FieldSet((&#39;first_name&#39;, &#39;last_name&#39;, &#39;email&#39;, &#39;phone&#39;), &#39;User&#39;),</span>
<span class="sd">                    # ... and it is just shortcut for:</span>
<span class="sd">                    rules.Header(&#39;User&#39;),</span>
<span class="sd">                    rules.Field(&#39;first_name&#39;),</span>
<span class="sd">                    rules.Field(&#39;last_name&#39;),</span>
<span class="sd">                    # ...</span>
<span class="sd">                    # It is possible to create custom rule blocks:</span>
<span class="sd">                    MyBlock(&#39;Hello World&#39;),</span>
<span class="sd">                    # It is possible to call macros from current context</span>
<span class="sd">                    rules.Macro(&#39;my_macro&#39;, foobar=&#39;baz&#39;)</span>
<span class="sd">                ]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_edit_rules</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Customized rules for the edit form. Override `form_rules` if present.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form_create_rules</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Customized rules for the create form. Override `form_rules` if present.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Actions</span>
    <span class="n">action_disallowed_list</span> <span class="o">=</span> <span class="n">ObsoleteAttr</span><span class="p">(</span><span class="s1">&#39;action_disallowed_list&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;disallowed_actions&#39;</span><span class="p">,</span>
                                          <span class="p">[])</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set of disallowed action names. For example, if you want to disable</span>
<span class="sd">        mass model deletion, do something like this:</span>

<span class="sd">            class MyModelView(BaseModelView):</span>
<span class="sd">                action_disallowed_list = [&#39;delete&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Export settings</span>
    <span class="n">export_max_rows</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maximum number of rows allowed for export.</span>

<span class="sd">        Unlimited by default. Uses `page_size` if set to `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Various settings</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default page size for pagination.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">menu_class_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">menu_icon_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">menu_icon_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Constructor.</span>

<span class="sd">            :param model:</span>
<span class="sd">                Model class</span>
<span class="sd">            :param name:</span>
<span class="sd">                View name. If not provided, will use the model class name</span>
<span class="sd">            :param category:</span>
<span class="sd">                View category</span>
<span class="sd">            :param endpoint:</span>
<span class="sd">                Base endpoint. If not provided, will use the model name.</span>
<span class="sd">            :param url:</span>
<span class="sd">                Base URL. If not provided, will use endpoint as a URL.</span>
<span class="sd">            :param menu_class_name:</span>
<span class="sd">                Optional class name for the menu item.</span>
<span class="sd">            :param menu_icon_type:</span>
<span class="sd">                Optional icon. Possible icon types:</span>

<span class="sd">                 - `flask_admin.consts.ICON_TYPE_GLYPH` - Bootstrap glyph icon</span>
<span class="sd">                 - `flask_admin.consts.ICON_TYPE_FONT_AWESOME` - Font Awesome icon</span>
<span class="sd">                 - `flask_admin.consts.ICON_TYPE_IMAGE` - Image relative to Flask static directory</span>
<span class="sd">                 - `flask_admin.consts.ICON_TYPE_IMAGE_URL` - Image with full URL</span>
<span class="sd">            :param menu_icon_value:</span>
<span class="sd">                Icon glyph name or URL, depending on `menu_icon_type` setting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="c1"># If name not provided, it is model name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prettify_class_name</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">BaseModelView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">static_folder</span><span class="p">,</span>
                                            <span class="n">menu_class_name</span><span class="o">=</span><span class="n">menu_class_name</span><span class="p">,</span>
                                            <span class="n">menu_icon_type</span><span class="o">=</span><span class="n">menu_icon_type</span><span class="p">,</span>
                                            <span class="n">menu_icon_value</span><span class="o">=</span><span class="n">menu_icon_value</span><span class="p">)</span>

        <span class="c1"># Actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_actions</span><span class="p">()</span>

        <span class="c1"># Scaffolding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_cache</span><span class="p">()</span>

    <span class="c1"># Endpoint</span>
    <span class="k">def</span> <span class="nf">_get_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">endpoint</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BaseModelView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_endpoint</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Caching</span>
    <span class="k">def</span> <span class="nf">_refresh_forms_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Forms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_form_ajax_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_ajax_references</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_widget_args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form_widget_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_create_form</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edit_form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edit_form</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_delete_form</span><span class="p">()</span>

        <span class="c1"># List View In-Line Editing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_editable_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_list_form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_form</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_editable_list</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_refresh_filters_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filters</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_groups</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_args</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">as_unicode</span><span class="p">(</span><span class="n">flt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_groups</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_groups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">FilterGroup</span><span class="p">(</span><span class="n">flt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_filter_groups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s1">&#39;arg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_arg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">flt</span><span class="p">),</span>
                    <span class="s1">&#39;operation&#39;</span><span class="p">:</span> <span class="n">flt</span><span class="o">.</span><span class="n">operation</span><span class="p">(),</span>
                    <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">flt</span><span class="o">.</span><span class="n">get_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">flt</span><span class="o">.</span><span class="n">data_type</span>
                <span class="p">})</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_filter_args</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_filter_arg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">flt</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">flt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_groups</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_args</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_refresh_form_rules_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_create_rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_form_create_rules</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">RuleSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_create_rules</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_form_create_rules</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_edit_rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_form_edit_rules</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">RuleSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_edit_rules</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_form_edit_rules</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_rules</span><span class="p">:</span>
            <span class="n">form_rules</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">RuleSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_rules</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form_create_rules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_form_create_rules</span> <span class="o">=</span> <span class="n">form_rules</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form_edit_rules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_form_edit_rules</span> <span class="o">=</span> <span class="n">form_rules</span>

    <span class="k">def</span> <span class="nf">_refresh_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Refresh various cached variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># List view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_columns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sortable_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sortable_columns</span><span class="p">()</span>

        <span class="c1"># Details view</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_view_details</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_details_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_details_columns</span><span class="p">()</span>

        <span class="c1"># Export view</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_export</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_export_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_export_columns</span><span class="p">()</span>

        <span class="c1"># Labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_labels</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_labels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Forms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_forms_cache</span><span class="p">()</span>

        <span class="c1"># Search</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_supported</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_search</span><span class="p">()</span>

        <span class="c1"># Choices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_choices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_column_choices_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
                <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">choices</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">choices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_choices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_choices_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Column formatters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_formatters_export</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_formatters_export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_formatters</span>

        <span class="c1"># Type formatters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_type_formatters</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_type_formatters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">typefmt</span><span class="o">.</span><span class="n">BASE_FORMATTERS</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_type_formatters_export</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_type_formatters_export</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">typefmt</span><span class="o">.</span><span class="n">EXPORT_FORMATTERS</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_descriptions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_descriptions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_filters_cache</span><span class="p">()</span>

        <span class="c1"># Form rendering rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_form_rules_cache</span><span class="p">()</span>

        <span class="c1"># Process form rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_form_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_form_edit_rules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_form_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_form_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_form_create_rules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_form_class</span><span class="p">)</span>

    <span class="c1"># Primary key</span>
    <span class="k">def</span> <span class="nf">get_pk_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return PK value from a model object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># List view</span>
    <span class="k">def</span> <span class="nf">scaffold_list_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return list of the model field names. Must be implemented in</span>
<span class="sd">            the child class.</span>

<span class="sd">            Expected return format is list of tuples with field name and</span>
<span class="sd">            display text. For example::</span>

<span class="sd">                [&#39;name&#39;, &#39;first_name&#39;, &#39;last_name&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Please implement scaffold_list_columns method&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_column_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return a human-readable column name.</span>

<span class="sd">            :param field:</span>
<span class="sd">                Model field name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_labels</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_labels</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_labels</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prettify_name</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_list_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a list of the model field names. If `column_list` was</span>
<span class="sd">            set, returns it. Otherwise calls `scaffold_list_columns`</span>
<span class="sd">            to generate the list from the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_list</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_list_columns</span><span class="p">()</span>

            <span class="c1"># Filter excluded columns</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_exclude_list</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_exclude_list</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_name</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_details_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a list of the model field names in the details view. If</span>
<span class="sd">            `column_details_list` was set, returns it. Otherwise calls</span>
<span class="sd">            `scaffold_list_columns` to generate the list from the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_details_list</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_list_columns</span><span class="p">()</span>

            <span class="c1"># Filter excluded columns</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_details_exclude_list</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span>
                           <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_details_exclude_list</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_name</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_export_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a list of the model field names in the export view. If</span>
<span class="sd">            `column_export_list` was set, returns it. Otherwise, if</span>
<span class="sd">            `column_list` was set, returns it. Otherwise calls</span>
<span class="sd">            `scaffold_list_columns` to generate the list from the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_export_list</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_list</span>

            <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_list_columns</span><span class="p">()</span>

            <span class="c1"># Filter excluded columns</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_export_exclude_list</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span>
                           <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_export_exclude_list</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_name</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">scaffold_sortable_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns dictionary of sortable columns. Must be implemented in</span>
<span class="sd">            the child class.</span>

<span class="sd">            Expected return format is a dictionary, where keys are field names and</span>
<span class="sd">            values are property names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Please implement scaffold_sortable_columns method&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sortable_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a dictionary of the sortable columns. Key is a model</span>
<span class="sd">            field name and value is sort column (for example - attribute).</span>

<span class="sd">            If `column_sortable_list` is set, will use it. Otherwise, will call</span>
<span class="sd">            `scaffold_sortable_columns` to get them from the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_sortable_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_sortable_columns</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_sortable_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">init_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialize search. If data provider does not support search,</span>
<span class="sd">            `init_search` will return `False`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># Filter helpers</span>
    <span class="k">def</span> <span class="nf">scaffold_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate filter object for the given name</span>

<span class="sd">            :param name:</span>
<span class="sd">                Name of the field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">is_valid_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Verify that the provided filter object is valid.</span>

<span class="sd">            Override in model backend implementation to verify if</span>
<span class="sd">            the provided filter type is allowed.</span>

<span class="sd">            :param filter:</span>
<span class="sd">                Filter object to verify.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">filters</span><span class="o">.</span><span class="n">BaseFilter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Postprocess (add joins, etc) for a filter.</span>

<span class="sd">            :param filter:</span>
<span class="sd">                Filter object to postprocess</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">filter</span>

    <span class="k">def</span> <span class="nf">get_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return a list of filter objects.</span>

<span class="sd">            If your model backend implementation does not support filters,</span>
<span class="sd">            override this method and return `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_filters</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_filters</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_filter</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_filter</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_filters</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">flt</span><span class="p">:</span>
                        <span class="n">collection</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flt</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unsupported filter type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">collection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">get_filter_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">flt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Given a filter `flt`, return a unique name for that filter in</span>
<span class="sd">            this view.</span>

<span class="sd">            Does not include the `flt[n]_` portion of the filter name.</span>

<span class="sd">            :param index:</span>
<span class="sd">                Filter index in _filters array</span>
<span class="sd">            :param flt:</span>
<span class="sd">                Filter instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_filter_urls</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">as_unicode</span><span class="p">(</span><span class="n">flt</span><span class="o">.</span><span class="n">operation</span><span class="p">())))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">filter_char_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">filter_compact_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_filter_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns non-lazy version of filter strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_groups</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_groups</span><span class="p">):</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">items</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">non_lazy</span><span class="p">()</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># Form helpers</span>
    <span class="k">def</span> <span class="nf">scaffold_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create `form.BaseForm` inherited class from the model. Must be</span>
<span class="sd">            implemented in the child class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Please implement scaffold_form method&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scaffold_list_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_fieldlist</span><span class="o">=</span><span class="n">ListEditableFieldList</span><span class="p">,</span>
                           <span class="n">validators</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create form for the `index_view` using only the columns from</span>
<span class="sd">            `self.column_editable_list`.</span>

<span class="sd">            :param validators:</span>
<span class="sd">                `form_args` dict with only validators</span>
<span class="sd">                {&#39;name&#39;: {&#39;validators&#39;: [DataRequired()]}}</span>
<span class="sd">            :param custom_fieldlist:</span>
<span class="sd">                A WTForm FieldList class. By default, `ListEditableFieldList`.</span>

<span class="sd">            Must be implemented in the child class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Please implement scaffold_list_form method&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get form class.</span>

<span class="sd">            If ``self.form`` is set, will return it and will call</span>
<span class="sd">            ``self.scaffold_form`` otherwise.</span>

<span class="sd">            Override to implement customized behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_form</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_list_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get form class for the editable list view.</span>

<span class="sd">            Uses only validators from `form_args` to build the form class.</span>

<span class="sd">            Allows overriding the editable list view field/widget. For example::</span>

<span class="sd">                from flask_admin.model.fields import ListEditableFieldList</span>
<span class="sd">                from flask_admin.model.widgets import XEditableWidget</span>

<span class="sd">                class CustomWidget(XEditableWidget):</span>
<span class="sd">                    def get_kwargs(self, subfield, kwargs):</span>
<span class="sd">                        if subfield.type == &#39;TextAreaField&#39;:</span>
<span class="sd">                            kwargs[&#39;data-type&#39;] = &#39;textarea&#39;</span>
<span class="sd">                            kwargs[&#39;data-rows&#39;] = &#39;20&#39;</span>
<span class="sd">                        # elif: kwargs for other fields</span>

<span class="sd">                        return kwargs</span>

<span class="sd">                class CustomFieldList(ListEditableFieldList):</span>
<span class="sd">                    widget = CustomWidget()</span>

<span class="sd">                class MyModelView(BaseModelView):</span>
<span class="sd">                    def get_list_form(self):</span>
<span class="sd">                        return self.scaffold_list_form(CustomFieldList)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_args</span><span class="p">:</span>
            <span class="c1"># get only validators, other form_args can break FieldList wrapper</span>
            <span class="n">validators</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;validators&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;validators&quot;</span><span class="p">]})</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form_args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validators&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validators</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_list_form</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="n">validators</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_create_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create form class for model creation view.</span>

<span class="sd">            Override to implement customized behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_form</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_edit_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create form class for model editing view.</span>

<span class="sd">            Override to implement customized behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_form</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_delete_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create form class for model delete view.</span>

<span class="sd">            Override to implement customized behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">DeleteForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form_base_class</span><span class="p">):</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">HiddenField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">InputRequired</span><span class="p">()])</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">HiddenField</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">DeleteForm</span>

    <span class="k">def</span> <span class="nf">create_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Instantiate model creation form and return it.</span>

<span class="sd">            Override to implement custom behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_form_class</span><span class="p">(</span><span class="n">get_form_data</span><span class="p">(),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">edit_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Instantiate model editing form and return it.</span>

<span class="sd">            Override to implement custom behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_form_class</span><span class="p">(</span><span class="n">get_form_data</span><span class="p">(),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Instantiate model delete form and return it.</span>

<span class="sd">            Override to implement custom behavior.</span>

<span class="sd">            The delete form originally used a GET request, so delete_form</span>
<span class="sd">            accepts both GET and POST request for backwards compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_form_class</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># allow request.args for backward compatibility</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_form_class</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_form_class</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Instantiate model editing form for list view and return it.</span>

<span class="sd">            Override to implement custom behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_form_class</span><span class="p">(</span><span class="n">get_form_data</span><span class="p">(),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Validate the form on submit.</span>

<span class="sd">            :param form:</span>
<span class="sd">                Form to validate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">validate_form_on_submit</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_save_return_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_created</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return url where user is redirected after successful form save.</span>

<span class="sd">            :param model:</span>
<span class="sd">                Saved object</span>
<span class="sd">            :param is_created:</span>
<span class="sd">                Whether new object was created or existing one was updated</span>

<span class="sd">            For example, redirect use to object details view after form save::</span>

<span class="sd">                class MyModelView(ModelView):</span>
<span class="sd">                    can_view_details = True</span>

<span class="sd">                    def get_save_return_url(self, model, is_created):</span>
<span class="sd">                        return self.get_url(&#39;.details_view&#39;, id=model.id)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_redirect_target</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.index_view&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_ruleset_missing_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ruleset</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">missing_fields</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">ruleset</span><span class="p">:</span>
            <span class="n">visible_fields</span> <span class="o">=</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">visible_fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visible_fields</span><span class="p">:</span>
                    <span class="n">missing_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">missing_fields</span>

    <span class="k">def</span> <span class="nf">_show_missing_fields_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_form_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ruleset</span><span class="p">,</span> <span class="n">form_class</span><span class="p">,</span> <span class="n">remove_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">form_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">form_class</span><span class="o">.</span><span class="n">__dict__</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">UnboundField</span><span class="p">):</span>
                <span class="n">form_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">missing_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ruleset</span><span class="p">:</span>
            <span class="n">visible_fields</span> <span class="o">=</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">visible_fields</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">form_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visible_fields</span><span class="p">:</span>
                    <span class="n">missing_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_missing_fields_warning</span><span class="p">(</span><span class="s1">&#39;Fields missing from ruleset: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">remove_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_fields_from_form_class</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">,</span> <span class="n">form_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_form_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ruleset</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">remove_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">missing_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ruleset_missing_fields</span><span class="p">(</span><span class="n">ruleset</span><span class="o">=</span><span class="n">ruleset</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_missing_fields_warning</span><span class="p">(</span><span class="s1">&#39;Fields missing from ruleset: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">remove_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_fields_from_form_instance</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_fields_from_form_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_fields_from_form_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">form_class</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">form_class</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

    <span class="c1"># Helpers</span>
    <span class="k">def</span> <span class="nf">is_sortable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Verify if column is sortable.</span>

<span class="sd">            Not case-sensitive.</span>

<span class="sd">            :param name:</span>
<span class="sd">                Column name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sortable_columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_editable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Verify if column is editable.</span>

<span class="sd">            :param name:</span>
<span class="sd">                Column name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_editable_list</span>

    <span class="k">def</span> <span class="nf">_get_column_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return column index by</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_columns</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_columns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_default_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return default sort order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_default_sort</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_default_sort</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_default_sort</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_default_sort</span><span class="p">,</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># Database-related API</span>
    <span class="k">def</span> <span class="nf">get_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">sort_field</span><span class="p">,</span> <span class="n">sort_desc</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span>
                 <span class="n">page_size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return a paginated and sorted list of models from the data source.</span>

<span class="sd">            Must be implemented in the child class.</span>

<span class="sd">            :param page:</span>
<span class="sd">                Page number, 0 based. Can be set to None if it is first page.</span>
<span class="sd">            :param sort_field:</span>
<span class="sd">                Sort column name or None.</span>
<span class="sd">            :param sort_desc:</span>
<span class="sd">                If set to True, sorting is in descending order.</span>
<span class="sd">            :param search:</span>
<span class="sd">                Search query</span>
<span class="sd">            :param filters:</span>
<span class="sd">                List of filter tuples. First value in a tuple is a search</span>
<span class="sd">                index, second value is a search value.</span>
<span class="sd">            :param page_size:</span>
<span class="sd">                Number of results. Defaults to ModelView&#39;s page_size. Can be</span>
<span class="sd">                overriden to change the page_size limit. Removing the page_size</span>
<span class="sd">                limit requires setting page_size to 0 or False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Please implement get_list method&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return one model by its id.</span>

<span class="sd">            Must be implemented in the child class.</span>

<span class="sd">            :param id:</span>
<span class="sd">                Model id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Please implement get_one method&#39;</span><span class="p">)</span>

    <span class="c1"># Exception handler</span>
    <span class="k">def</span> <span class="nf">handle_view_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">as_unicode</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># Model event handlers</span>
    <span class="k">def</span> <span class="nf">on_model_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_created</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform some actions before a model is created or updated.</span>

<span class="sd">            Called from create_model and update_model in the same transaction</span>
<span class="sd">            (if it has any meaning for a store backend).</span>

<span class="sd">            By default does nothing.</span>

<span class="sd">            :param form:</span>
<span class="sd">                Form used to create/update model</span>
<span class="sd">            :param model:</span>
<span class="sd">                Model that will be created/updated</span>
<span class="sd">            :param is_created:</span>
<span class="sd">                Will be set to True if model was created and to False if edited</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_on_model_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_created</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Compatibility helper.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_model_change</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_created</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.on_model_change() now accepts third &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;parameter is_created. Please update your code&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">on_model_change</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_model_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_created</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform some actions after a model was created or updated and</span>
<span class="sd">            committed to the database.</span>

<span class="sd">            Called from create_model after successful database commit.</span>

<span class="sd">            By default does nothing.</span>

<span class="sd">            :param form:</span>
<span class="sd">                Form used to create/update model</span>
<span class="sd">            :param model:</span>
<span class="sd">                Model that was created/updated</span>
<span class="sd">            :param is_created:</span>
<span class="sd">                True if model was created, False if model was updated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_model_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform some actions before a model is deleted.</span>

<span class="sd">            Called from delete_model in the same transaction</span>
<span class="sd">            (if it has any meaning for a store backend).</span>

<span class="sd">            By default do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">after_model_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform some actions after a model was deleted and</span>
<span class="sd">            committed to the database.</span>

<span class="sd">            Called from delete_model after successful database commit</span>
<span class="sd">            (if it has any meaning for a store backend).</span>

<span class="sd">            By default does nothing.</span>

<span class="sd">            :param model:</span>
<span class="sd">                Model that was deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_form_prefill</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform additional actions to pre-fill the edit form.</span>

<span class="sd">            Called from edit_view, if the current action is rendering</span>
<span class="sd">            the form rather than receiving client side input, after</span>
<span class="sd">            default pre-filling has been performed.</span>

<span class="sd">            By default does nothing.</span>

<span class="sd">            You only need to override this if you have added custom</span>
<span class="sd">            fields that depend on the database contents in a way that</span>
<span class="sd">            Flask-admin can&#39;t figure out by itself. Fields that were</span>
<span class="sd">            added by name of a normal column or relationship should</span>
<span class="sd">            work out of the box.</span>

<span class="sd">            :param form:</span>
<span class="sd">                Form instance</span>
<span class="sd">            :param id:</span>
<span class="sd">                id of the object that is going to be edited</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create model from the form.</span>

<span class="sd">            Returns the model instance if operation succeeded.</span>

<span class="sd">            Must be implemented in the child class.</span>

<span class="sd">            :param form:</span>
<span class="sd">                Form instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update model from the form.</span>

<span class="sd">            Returns `True` if operation succeeded.</span>

<span class="sd">            Must be implemented in the child class.</span>

<span class="sd">            :param form:</span>
<span class="sd">                Form instance</span>
<span class="sd">            :param model:</span>
<span class="sd">                Model instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Delete model.</span>

<span class="sd">            Returns `True` if operation succeeded.</span>

<span class="sd">            Must be implemented in the child class.</span>

<span class="sd">            :param model:</span>
<span class="sd">                Model instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># Various helpers</span>
    <span class="k">def</span> <span class="nf">_prettify_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Prettify pythonic variable name.</span>

<span class="sd">            For example, &#39;hello_world&#39; will be converted to &#39;Hello World&#39;</span>

<span class="sd">            :param name:</span>
<span class="sd">                Name to prettify</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prettify_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_empty_list_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;There are no items in the table.&#39;</span><span class="p">)</span>

    <span class="c1"># URL generation helpers</span>
    <span class="k">def</span> <span class="nf">_get_list_filter_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;flt&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">pos</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_args</span><span class="p">:</span>
                    <span class="n">idx</span><span class="p">,</span> <span class="n">flt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">flt</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">as_unicode</span><span class="p">(</span><span class="n">flt</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">value</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Invalid Filter Value: </span><span class="si">%(value)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>

            <span class="c1"># Sort filters</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_get_list_extra_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return arguments from query string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ViewArgs</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                        <span class="n">sort</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                        <span class="n">sort_desc</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                        <span class="n">search</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_list_filter_args</span><span class="p">())</span>

    <span class="c1"># URL generation helpers</span>
    <span class="k">def</span> <span class="nf">_get_list_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate page URL with current page, sort column and</span>
<span class="sd">            other parameters.</span>

<span class="sd">            :param view:</span>
<span class="sd">                View name</span>
<span class="sd">            :param view_args:</span>
<span class="sd">                ViewArgs object with page number, filters, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">view_args</span><span class="o">.</span><span class="n">page</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">view_args</span><span class="o">.</span><span class="n">sort_desc</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">sort</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">search</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">extra_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">view_args</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">filters</span><span class="p">):</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">flt_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pair</span>

                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;flt</span><span class="si">%d</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_arg</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.index_view&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Actions</span>
    <span class="k">def</span> <span class="nf">is_action_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Override this method to allow or disallow actions based</span>
<span class="sd">            on some condition.</span>

<span class="sd">            The default implementation only checks if the particular action</span>
<span class="sd">            is not in `action_disallowed_list`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_disallowed_list</span>

    <span class="k">def</span> <span class="nf">_get_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get unformatted field value from the model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rec_getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_list_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">column_formatters</span><span class="p">,</span>
                        <span class="n">column_type_formatters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the value to be displayed.</span>

<span class="sd">            :param context:</span>
<span class="sd">                :py:class:`jinja2.runtime.Context` if available</span>
<span class="sd">            :param model:</span>
<span class="sd">                Model instance</span>
<span class="sd">            :param name:</span>
<span class="sd">                Field name</span>
<span class="sd">            :param column_formatters:</span>
<span class="sd">                column_formatters to be used.</span>
<span class="sd">            :param column_type_formatters:</span>
<span class="sd">                column_type_formatters to be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column_fmt</span> <span class="o">=</span> <span class="n">column_formatters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">column_fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">column_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_value</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">choices_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_choices_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">choices_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">choices_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span>

        <span class="n">type_fmt</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">typeobj</span><span class="p">,</span> <span class="n">formatter</span> <span class="ow">in</span> <span class="n">column_type_formatters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">typeobj</span><span class="p">):</span>
                <span class="n">type_fmt</span> <span class="o">=</span> <span class="n">formatter</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">type_fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">type_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@contextfunction</span>
    <span class="k">def</span> <span class="nf">get_list_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the value to be displayed in the list view</span>

<span class="sd">            :param context:</span>
<span class="sd">                :py:class:`jinja2.runtime.Context`</span>
<span class="sd">            :param model:</span>
<span class="sd">                Model instance</span>
<span class="sd">            :param name:</span>
<span class="sd">                Field name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_value</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_formatters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_type_formatters</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_export_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the value to be displayed in export.</span>
<span class="sd">            Allows export to use different (non HTML) formatters.</span>

<span class="sd">            :param model:</span>
<span class="sd">                Model instance</span>
<span class="sd">            :param name:</span>
<span class="sd">                Field name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_value</span><span class="p">(</span>
            <span class="bp">None</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_formatters_export</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_type_formatters_export</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># AJAX references</span>
    <span class="k">def</span> <span class="nf">_process_ajax_references</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Process `form_ajax_refs` and generate model loaders that</span>
<span class="sd">            will be used by the `ajax_lookup` view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_ajax_refs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form_ajax_refs</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ajax_loader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">AjaxModelLoader</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.form_ajax_refs can not handle </span><span class="si">%s</span><span class="s1"> types&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">options</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_create_ajax_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Model backend will override this to implement AJAX model loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># Views</span>
    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">index_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            List view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_editable_list</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_form</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_delete</span><span class="p">:</span>
            <span class="n">delete_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_form</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delete_form</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Grab parameters from URL</span>
        <span class="n">view_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_extra_args</span><span class="p">()</span>

        <span class="c1"># Map column index to column name</span>
        <span class="n">sort_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_by_idx</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sort_column</span> <span class="o">=</span> <span class="n">sort_column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get count and data</span>
        <span class="n">count</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="n">sort_column</span><span class="p">,</span> <span class="n">view_args</span><span class="o">.</span><span class="n">sort_desc</span><span class="p">,</span>
                                    <span class="n">view_args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">view_args</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>

        <span class="c1"># Calculate number of pages</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">num_pages</span> <span class="o">=</span> <span class="n">count</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_pages</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_pages</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Various URL generation helpers</span>
        <span class="k">def</span> <span class="nf">pager_url</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c1"># Do not add page number if it is first page</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_url</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">p</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">sort_url</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">invert</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">view_args</span><span class="o">.</span><span class="n">sort_desc</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_url</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">sort_desc</span><span class="o">=</span><span class="n">desc</span><span class="p">))</span>

        <span class="c1"># Actions</span>
        <span class="n">actions</span><span class="p">,</span> <span class="n">actions_confirmation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_actions_list</span><span class="p">()</span>

        <span class="n">clear_search_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_url</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                              <span class="n">sort</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">sort</span><span class="p">,</span>
                                                              <span class="n">sort_desc</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">sort_desc</span><span class="p">,</span>
                                                              <span class="n">search</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                                              <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_template</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
            <span class="n">delete_form</span><span class="o">=</span><span class="n">delete_form</span><span class="p">,</span>

            <span class="c1"># List</span>
            <span class="n">list_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_columns</span><span class="p">,</span>
            <span class="n">sortable_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sortable_columns</span><span class="p">,</span>
            <span class="n">editable_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_editable_list</span><span class="p">,</span>

            <span class="c1"># Pagination</span>
            <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
            <span class="n">pager_url</span><span class="o">=</span><span class="n">pager_url</span><span class="p">,</span>
            <span class="n">num_pages</span><span class="o">=</span><span class="n">num_pages</span><span class="p">,</span>
            <span class="n">page</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">page</span><span class="p">,</span>
            <span class="n">page_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">page_size</span><span class="p">,</span>

            <span class="c1"># Sorting</span>
            <span class="n">sort_column</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">sort_desc</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">sort_desc</span><span class="p">,</span>
            <span class="n">sort_url</span><span class="o">=</span><span class="n">sort_url</span><span class="p">,</span>

            <span class="c1"># Search</span>
            <span class="n">search_supported</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_supported</span><span class="p">,</span>
            <span class="n">clear_search_url</span><span class="o">=</span><span class="n">clear_search_url</span><span class="p">,</span>
            <span class="n">search</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span>

            <span class="c1"># Filters</span>
            <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">,</span>
            <span class="n">filter_groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_groups</span><span class="p">(),</span>
            <span class="n">active_filters</span><span class="o">=</span><span class="n">view_args</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>

            <span class="c1"># Actions</span>
            <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="p">,</span>
            <span class="n">actions_confirmation</span><span class="o">=</span><span class="n">actions_confirmation</span><span class="p">,</span>

            <span class="c1"># Misc</span>
            <span class="nb">enumerate</span><span class="o">=</span><span class="nb">enumerate</span><span class="p">,</span>
            <span class="n">get_pk_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pk_value</span><span class="p">,</span>
            <span class="n">get_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_list_value</span><span class="p">,</span>
            <span class="n">return_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_list_url</span><span class="p">(</span><span class="n">view_args</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/new/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">create_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create model view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">get_redirect_target</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.index_view&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_form</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s1">&#39;_validated_ruleset&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">_validated_ruleset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_form_instance</span><span class="p">(</span><span class="n">ruleset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_form_create_rules</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_form</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
            <span class="c1"># in versions 1.1.0 and before, this returns a boolean</span>
            <span class="c1"># in later versions, this is the model itself</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Record was successfully created.&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;_add_another&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;_continue_editing&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                    <span class="c1"># if we have a valid model, try to go to the edit view</span>
                    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.edit_view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pk_value</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">url</span><span class="o">=</span><span class="n">return_url</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="n">return_url</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># save button</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_save_return_url</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">is_created</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

        <span class="n">form_opts</span> <span class="o">=</span> <span class="n">FormOpts</span><span class="p">(</span><span class="n">widget_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form_widget_args</span><span class="p">,</span>
                             <span class="n">form_rules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_form_create_rules</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_modal</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modal&#39;</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_modal_template</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_template</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template</span><span class="p">,</span>
                           <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                           <span class="n">form_opts</span><span class="o">=</span><span class="n">form_opts</span><span class="p">,</span>
                           <span class="n">return_url</span><span class="o">=</span><span class="n">return_url</span><span class="p">)</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/edit/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">edit_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Edit model view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">get_redirect_target</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.index_view&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_edit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="n">get_mdict_item_or_list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_one</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Record does not exist.&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_form</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s1">&#39;_validated_ruleset&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">_validated_ruleset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_form_instance</span><span class="p">(</span><span class="n">ruleset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_form_edit_rules</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_form</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Record was successfully saved.&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;_add_another&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.create_view&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">return_url</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s1">&#39;_continue_editing&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># save button</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_save_return_url</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">is_created</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_form_prefill</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

        <span class="n">form_opts</span> <span class="o">=</span> <span class="n">FormOpts</span><span class="p">(</span><span class="n">widget_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form_widget_args</span><span class="p">,</span>
                             <span class="n">form_rules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_form_edit_rules</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_modal</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modal&#39;</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_modal_template</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_template</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template</span><span class="p">,</span>
                           <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                           <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                           <span class="n">form_opts</span><span class="o">=</span><span class="n">form_opts</span><span class="p">,</span>
                           <span class="n">return_url</span><span class="o">=</span><span class="n">return_url</span><span class="p">)</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/details/&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">details_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Details model view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">get_redirect_target</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.index_view&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_view_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="n">get_mdict_item_or_list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_one</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Record does not exist.&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">details_modal</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modal&#39;</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">details_modal_template</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">details_template</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template</span><span class="p">,</span>
                           <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                           <span class="n">details_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_details_columns</span><span class="p">,</span>
                           <span class="n">get_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_list_value</span><span class="p">,</span>
                           <span class="n">return_url</span><span class="o">=</span><span class="n">return_url</span><span class="p">)</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/delete/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">delete_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Delete model view. Only POST method is allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">get_redirect_target</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.index_view&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_delete</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_form</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_form</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
             <span class="c1"># id is InputRequired()</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">data</span>

            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_one</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Record does not exist.&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

            <span class="c1"># message is flashed from within delete_model if it fails</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Record was successfully deleted.&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash_errors</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Failed to delete record. </span><span class="si">%(error)s</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/action/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">action_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Mass-model action view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_action</span><span class="p">()</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/export/csv/&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">export_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Export a CSV of records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">get_redirect_target</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;.index_view&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_export</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Permission denied.&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

        <span class="c1"># Macros in column_formatters are not supported.</span>
        <span class="c1"># Macros will have a function name &#39;inner&#39;</span>
        <span class="c1"># This causes non-macro functions named &#39;inner&#39; not work.</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_formatters</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;inner&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;Macros not implemented. Override with &#39;</span>
                    <span class="s1">&#39;column_formatters_export. Column: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">,)</span>
                <span class="p">)</span>

        <span class="c1"># Grab parameters from URL</span>
        <span class="n">view_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_extra_args</span><span class="p">()</span>

        <span class="c1"># Map column index to column name</span>
        <span class="n">sort_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_by_idx</span><span class="p">(</span><span class="n">view_args</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sort_column</span> <span class="o">=</span> <span class="n">sort_column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get count and data</span>
        <span class="n">count</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sort_column</span><span class="p">,</span> <span class="n">view_args</span><span class="o">.</span><span class="n">sort_desc</span><span class="p">,</span>
                                    <span class="n">view_args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">view_args</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
                                    <span class="n">page_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">export_max_rows</span><span class="p">)</span>

        <span class="c1"># https://docs.djangoproject.com/en/1.8/howto/outputting-csv/</span>
        <span class="k">class</span> <span class="nc">Echo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            An object that implements just the write method of the file-like</span>
<span class="sd">            interface.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Write the value by returning it, instead of storing</span>
<span class="sd">                in a buffer.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">Echo</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">generate</span><span class="p">():</span>
            <span class="c1"># Append the column titles at the beginning</span>
            <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">csv_encode</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_columns</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">csv_encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_export_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_columns</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                  <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">))</span>

        <span class="n">disposition</span> <span class="o">=</span> <span class="s1">&#39;attachment;filename=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">secure_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">),)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">stream_with_context</span><span class="p">(</span><span class="n">generate</span><span class="p">()),</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">:</span> <span class="n">disposition</span><span class="p">},</span>
            <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;text/csv&#39;</span>
        <span class="p">)</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/ajax/lookup/&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ajax_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form_ajax_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">loader</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">loader</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_list</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s1">&#39;/ajax/update/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">ajax_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Edits a single column of a record in list view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_editable_list</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_form</span><span class="p">()</span>

        <span class="c1"># prevent validation issues due to submitting a single field</span>
        <span class="c1"># delete all fields except the field being submitted</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="c1"># only the submitted field has a positive last_index</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;last_index&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_one</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">last_index</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;csrf_token&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Failed to update record. </span><span class="si">%(error)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="mi">500</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_form</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
                <span class="c1"># Success</span>
                <span class="k">return</span> <span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Record was successfully saved.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Error: No records changed, or problem saving to database.</span>
                <span class="n">msgs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">get_flashed_messages</span><span class="p">()])</span>
                <span class="k">return</span> <span class="n">gettext</span><span class="p">(</span><span class="s1">&#39;Failed to update record. </span><span class="si">%(error)s</span><span class="s1">&#39;</span><span class="p">,</span>
                               <span class="n">error</span><span class="o">=</span><span class="n">msgs</span><span class="p">),</span> <span class="mi">500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                    <span class="c1"># return validation error to x-editable</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="mi">500</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">error</span><span class="p">,</span> <span class="mi">500</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Alec Aivazis.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'v0.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>