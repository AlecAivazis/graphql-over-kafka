

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Querying The Distributed Structure &mdash; nautilus v0.3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="nautilus v0.3.0 documentation" href="../index.html"/>
        <link rel="up" title="Getting Started" href="index.html"/>
        <link rel="next" title="Authentication" href="auth.html"/>
        <link rel="prev" title="Connecting Services Together" href="connecting_services.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> nautilus
          

          
          </a>

          
            
            
              <div class="version">
                v0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">Installation / Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="first_service.html">Your First Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="connecting_services.html">Connecting Services Together</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Querying The Distributed Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth.html">Authentication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Action Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schema/index.html">Service API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/index.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internals/index.html">Module Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">nautilus</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Getting Started</a> &raquo;</li>
      
    <li>Querying The Distributed Structure</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/intro/api.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="querying-the-distributed-structure">
<h1>Querying The Distributed Structure<a class="headerlink" href="#querying-the-distributed-structure" title="Permalink to this headline">Â¶</a></h1>
<p>We now have three different services which are each responsible for maintaining
a small bit of the application. While this has many benefits, one rather large
annoyance is the difficulty to create a summary of our application using data
that spans many services.</p>
<p>One way to solve this is to create a service known as an &#8220;API gateway&#8221; which,
unlike the services we have encountered so far, does not maintain any sort of
internal state. Instead, this service just has a single schema that describes
the entire cloud. This has a few major benefits that are worth pointing out:</p>
<ul class="simple">
<li>The distributed nature of the cloud is completely hidden behind a single endpoint</li>
<li>Authorization is maintained by a single service</li>
<li>Various network optimizations only need to occur in a single place</li>
<li>The list of external mutations is in one place</li>
</ul>
<p>Let&#8217;s begin by creating a new file called <code class="docutils literal"><span class="pre">api.py</span></code> in our directory with the
following contents:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># external imports</span>
<span class="kn">from</span> <span class="nn">nautilus</span> <span class="kn">import</span> <span class="n">APIGateway</span><span class="p">,</span> <span class="n">ServiceManager</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">APIGateway</span><span class="p">()</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>If you try to run this file as is, an exception will be thrown since we have
not provided the service with a schema that describes the complete topology of
our cloud.</p>
<p>Normally, supporting this schema involes bouncing a lot of different queries
between various ModelServices and their connections in order to create a single
report. This easily becomes very difficult to maintain, is prone to bugs,
and leads to a significant amount of code duplication (which is bad). Nautilus
makes the creation and evaluation of this schema significantly easier.</p>
<p>Rather than basing your object types on an SQLAlchemyObjectType like
before, services that you wish to use as representation for an external service
should be based on the SerivceObjectType. Add the following code block at the
end of the api gateway file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">graphene</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">ObjectType</span><span class="p">,</span> <span class="n">Schema</span>
<span class="kn">from</span> <span class="nn">nautilus.api</span> <span class="kn">import</span> <span class="n">ServiceObjectType</span><span class="p">,</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">.recipes</span> <span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">RecipeService</span>
<span class="kn">from</span> <span class="nn">.ingredients</span> <span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">IngredientService</span>

<span class="k">class</span> <span class="nc">Ingredient</span><span class="p">(</span><span class="n">ServiceObjectType</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">IngredientService</span>


<span class="k">class</span> <span class="nc">Recipe</span><span class="p">(</span><span class="n">ServiceObjectType</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">RecipeService</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">ObjectType</span><span class="p">):</span>
    <span class="n">ingredients</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">Ingredient</span><span class="p">)</span>
    <span class="n">recipes</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">Recipes</span><span class="p">)</span>


<span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">()</span>
<span class="n">schema</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span>
</pre></div>
</div>
<p>Notice the class Meta defined inside of the ServiceObjectType. That paramter
takes a service to use as a base for field and query arguments.</p>
<p>Remember earlier when you used a Connection and it acted just like a list?
Well, that&#8217;s because the type you were connecting was a standard GraphQL one.
When the target of a connection is a service object, nautilus will use the
target&#8217;s service to look up the location of the remote service in the registry
and use its data. Go ahead and pass the schema to your service and give it a try.
You should be able to query the state of the recipe service from the api
service with a query like <code class="docutils literal"><span class="pre">{</span> <span class="pre">ingredients</span> <span class="pre">{</span> <span class="pre">name</span> <span class="pre">}}</span></code>. Pretty cool huh? Just
wait, it gets better.</p>
<p>Let&#8217;s tell the API Gateway that there is a connection between ingredients
and recipes by adding a Connection field to the recipe class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Recipe</span><span class="p">(</span><span class="n">ServiceObjectType</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">RecipeService</span>

    <span class="n">ingredients</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span>
                    <span class="n">Ingredient</span><span class="p">,</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;The ingredients in this recipe.&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>When the a Connection is used between two ServiceObjects, nautilus will look up
the details of the relationship from the corresponding service (assuming it is
an instance of ConnectionService) and perform all of the necessary
requests/joins to create the snapshot you asked for.</p>
<p>You can test this out with a query like <code class="docutils literal"><span class="pre">{</span> <span class="pre">recipes</span> <span class="pre">{name,</span> <span class="pre">ingredients</span> <span class="pre">{</span> <span class="pre">name</span> <span class="pre">}</span> <span class="pre">}</span> <span class="pre">}</span></code>.</p>
<p>As you can see, nautilus does a lot of work for us when creating a schema that
spans many servies. In the next section we will talk about user authentication
and add an authorization layer on top of our api gateway.</p>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="auth.html" class="btn btn-neutral float-right" title="Authentication" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="connecting_services.html" class="btn btn-neutral" title="Connecting Services Together" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Alec Aivazis.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v0.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>