

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Your First Service &mdash; nautilus v0.2.4 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="nautilus v0.2.4 documentation" href="../index.html"/>
        <link rel="up" title="Getting Started" href="index.html"/>
        <link rel="next" title="Connecting Services Together" href="connecting_services.html"/>
        <link rel="prev" title="Installation / Setup" href="installation.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> nautilus
          

          
          </a>

          
            
            
              <div class="version">
                v0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">Installation / Setup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Your First Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#defining-a-model">Defining a Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-a-schema">Building a Schema</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#querying-the-service-s-state">Querying the Service&#8217;s State</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#responding-to-actions">Responding to Actions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="connecting_services.html">Connecting Services Together</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html">Building an API Gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth.html">Authentication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Action Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schema/index.html">Service API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/index.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internals/index.html">Module Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">nautilus</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Getting Started</a> &raquo;</li>
      
    <li>Your First Service</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/intro/first_service.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="your-first-service">
<h1>Your First Service<a class="headerlink" href="#your-first-service" title="Permalink to this headline">¶</a></h1>
<p>Services are the fundamental building blocks for cloud applications powered by
nautilus. Let&#8217;s begin by creating a directory with an empty file somewhere on
your computer for us to use as a playground.</p>
<div class="highlight-bash"><div class="highlight"><pre>$ mkdir nautilus_playground <span class="o">&amp;&amp;</span> <span class="se">\</span>
        <span class="nb">cd</span> nautilus_playground <span class="o">&amp;&amp;</span> <span class="se">\</span>
        touch server.py
</pre></div>
</div>
<p>Now that we have a file, let&#8217;s make our first service. Keep in mind, that
this section is meant to illustrate the various parts of a service, as you
will see in the next section, the service we are about to construct can be
much more succintly created using one of nautilus&#8217;s pre-packaged services.
Open server.py in your favorite text editor and copy and paste the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">nautilus</span> <span class="kn">import</span> <span class="n">Service</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">Service</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my service&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">service</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>You could also have wrapped your service in a ServiceManager
&lt;nautilus.ServiceManager&gt; which provides various command line arguments.
Feel free to test that this works by executing this script in your console:</p>
<div class="highlight-bash"><div class="highlight"><pre>$ python3 ./server.py
</pre></div>
</div>
<p>If it complains about permissions, try running <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">chmod</span> <span class="pre">u+x</span> <span class="pre">./server.py</span></code>.
Assuming the regsitry is properly setup (ie consul is running), your terminal
should now indicate that the server started.</p>
<p>Right now, our service is nothing more than a flask application with some
default implementations of basic necessities like security. It doesn&#8217;t react
to the outside world, it doesn&#8217;t store any data, nor does it provide
anything for another service to use - let&#8217;s change that.</p>
<div class="section" id="defining-a-model">
<h2>Defining a Model<a class="headerlink" href="#defining-a-model" title="Permalink to this headline">¶</a></h2>
<p>Now that we have the service defined, let&#8217;s create a database table
that our service will manage. Nautilus uses SQLAlchemy for its internal
services and provides many helpers for common patterns. Therefore, while
not necessary, it is suggested that you also use SQLAlchemy to manage
your database. And honestly, it&#8217;s one of the nicest python packages written,
so why not take the opportunity when you can?</p>
<p>Throughout this guide, we&#8217;re going to be making a recipe list, so open up
server.py from the previous step and add the Recipe class.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">nautilus</span> <span class="kn">import</span> <span class="n">Service</span><span class="p">,</span> <span class="n">ServiceManager</span>
<span class="kn">from</span> <span class="nn">nautilus.models</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">HasID</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Text</span>

<span class="c1"># we&#39;re using the HasID mixin here to automatically provide a primary key</span>
<span class="c1"># for the table</span>
<span class="k">class</span> <span class="nc">Recipe</span><span class="p">(</span><span class="n">HasId</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the recipe&quot;</span><span class="p">)</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">Service</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my service&#39;</span><span class="p">)</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Notice we also wrapped the service in a manager, which provides a basic
command line interface for our service.</p>
<p>While our service still can&#8217;t talk to the outside world, at least it&#8217;s keep
track of our recipes for us. By inheriting from BaseModel &lt;nautilus.BaseModel&gt;
nautilus automatically registers this model with an admin interface. But
before we can look at the records, we have to create the database that will
persist the data. Since our service is now wrapped in a manager, we can easily
do this by executing the <code class="docutils literal"><span class="pre">syncdb</span></code> command:</p>
<div class="highlight-bash"><div class="highlight"><pre>$ python3 ./server.py syncdb
</pre></div>
</div>
<p>Now that you have a place to store your data, run the service and navigate your
browser to <code class="docutils literal"><span class="pre">localhost:8000/admin</span></code>.You should see a button at the top which
will bring you to a page for directly managing the recipe instances. While this
is rather convinient for humans, we will need to add a way for other services
to query this database.</p>
</div>
<div class="section" id="building-a-schema">
<h2>Building a Schema<a class="headerlink" href="#building-a-schema" title="Permalink to this headline">¶</a></h2>
<p>Traditionally, backend data is made availible via some sort of RESTful api. In
nautilus, services use a new technology called GraphQL from the facebook
engineers which allows the service to expose the data through a single
endpoint. For more information on GraphQL, visit this page.</p>
<p>Normally, building the description of our endpoint would result in a
significant amount of duplicated code (a new field for every model
attribute we want to include). However, recently the Graphene team added
automated support for SQLAlchemy models allowing us to add a graphql endpoint
to our service with a few additional lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">nautilus</span> <span class="kn">import</span> <span class="n">Service</span><span class="p">,</span> <span class="n">ServiceManager</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">nautilus.models</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">HasID</span>
<span class="kn">from</span> <span class="nn">nautilus.api.fields</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">graphene</span> <span class="kn">import</span> <span class="n">Schema</span>
<span class="kn">from</span> <span class="nn">graphene.contrib.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemyObjectType</span>

<span class="k">class</span> <span class="nc">Recipe</span><span class="p">(</span><span class="n">HasId</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the recipe&quot;</span><span class="p">)</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">session</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

<span class="nd">@schema.register</span>
<span class="k">class</span> <span class="nc">RecipeObjectType</span><span class="p">(</span><span class="n">SQLAlchemyObjectType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The GraphQL Object type for our recipes. &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Recipe</span>

<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">graphene</span><span class="o">.</span><span class="n">ObjectType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; the root level query for our recipe service &quot;&quot;&quot;</span>
    <span class="n">recipes</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">RecipeObjectType</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return all recipes in the database &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># add the root query to the schema</span>
<span class="n">schema</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">Service</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;my service&#39;</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">)</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Note: <code class="docutils literal"><span class="pre">Connection</span></code> is a very special type provided by nautilus.
For now, you can think of it as a wrapper around the List type that
we are using to make our code more easily read.</p>
<p>Sometimes, you might have to create the entire schema by hand, in which case
I suggest reading the graphene documentation [here](graphene). However, given
the simplicity of our Recipe model, Graphene can create the object for us.</p>
<div class="section" id="querying-the-service-s-state">
<h3>Querying the Service&#8217;s State<a class="headerlink" href="#querying-the-service-s-state" title="Permalink to this headline">¶</a></h3>
<p>Now that our service has been given schema, we can query the internal state of
the service using two different endpoints. Nautilus uses GraphQL as the service
query langauge. Take a second to familiarize yourself with forming a GraphQL
query by reading [this]() short blog post.</p>
<p>If you navigate to the root url of your service (<a class="reference external" href="http://localhost:8000">http://localhost:8000</a> by
default) you will see that the service  is trying to parse an incoming
query and can&#8217;t find one. You can give the service a query to fulfill by
padding a value to the <cite>query</cite> url parameter by navigating to a url like
<a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a>?query={recipes{ name }}.</p>
<p>While this does work, it&#8217;s clear this endpoint is not intended for human
consumption. Instead, if you point your browser to /graphiql you will
get visual environment for forming queries. I suggest opening a second tab
pointed at the admin interface previously discussed and proving to yourself
that the api is working as expected.</p>
</div>
</div>
<div class="section" id="responding-to-actions">
<h2>Responding to Actions<a class="headerlink" href="#responding-to-actions" title="Permalink to this headline">¶</a></h2>
<p>Now that our service maintains an internal state and can provide a summary of
that state to other services, all that&#8217;s left is to provide a way for the
service to mutate its state as it recieves actions. To do this, we
just need to define a function that takes two parameters: <code class="docutils literal"><span class="pre">type</span></code> and
<code class="docutils literal"><span class="pre">payload</span></code>. <code class="docutils literal"><span class="pre">Type</span></code> identifies the event which allows the service to decide
if it needs to respond. <code class="docutils literal"><span class="pre">Payload</span></code> provides the associated data for the event.
For example, if an action means to indicate that a new recipe needs to be
created, the service can treat the payload as the recipe&#8217;s attributes and
create the new record (or another mutation) when appropriate:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">nautilus</span> <span class="kn">import</span> <span class="n">Service</span><span class="p">,</span> <span class="n">ServiceManager</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">nautilus.models</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">HasID</span>
<span class="kn">from</span> <span class="nn">nautilus.api.fields</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">graphene</span> <span class="kn">import</span> <span class="n">Schema</span>
<span class="kn">from</span> <span class="nn">graphene.contrib.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemyObjectType</span>

<span class="k">class</span> <span class="nc">Recipe</span><span class="p">(</span><span class="n">HasId</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the recipe&quot;</span><span class="p">)</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span><span class="n">session</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

<span class="nd">@schema.register</span>
<span class="k">class</span> <span class="nc">RecipeObjectType</span><span class="p">(</span><span class="n">SQLAlchemyObjectType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The GraphQL Object type for our recipes. &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Recipe</span>

<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">graphene</span><span class="o">.</span><span class="n">ObjectType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; the root level query for our recipe service &quot;&quot;&quot;</span>
    <span class="n">recipes</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">RecipeObjectType</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return all recipes in the database &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># add the root query to the schema</span>
<span class="n">schema</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span>


<span class="k">def</span> <span class="nf">action_handler</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="c1"># if the payload represents a new recipe to create</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;create_recipe&#39;</span><span class="p">:</span>
        <span class="c1"># create a new instance of the recipe</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="n">Recipe</span><span class="p">(</span><span class="o">**</span><span class="n">payload</span><span class="p">)</span>
        <span class="c1"># save the recipe instance</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="n">service</span> <span class="o">=</span> <span class="n">Service</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;my service&#39;</span><span class="p">,</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">,</span>
    <span class="n">actionHandler</span> <span class="o">=</span> <span class="n">action_handler</span>
<span class="p">)</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Feel free to test this by....</p>
<p>Congratulations! You have finally pieced together a complete nautilus service.
Now other entities in your cloud (like another service or even a javascript
client) can create, persist, and retrieve recipes without maintaining the data
themselves. In the next section you will learn how to create services based
off of pre-packages ones as well as keep track of a relationships between
different services in your cloud.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="connecting_services.html" class="btn btn-neutral float-right" title="Connecting Services Together" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral" title="Installation / Setup" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Alec Aivazis.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v0.2.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>